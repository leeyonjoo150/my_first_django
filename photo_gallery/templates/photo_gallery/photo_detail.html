{% extends 'common/base.html' %}
{% block content %}
<!DOCTYPE html>
<html>
<head>
    <title>{{ photo.title }}</title>
</head>
<body>
    <nav>
        <a href="{% url 'photo_gallery:photo_list' %}">ê°¤ëŸ¬ë¦¬ë¡œ ëŒì•„ê°€ê¸°</a>
    </nav>

    <!-- ì´ì „/ë‹¤ìŒ ë„¤ë¹„ê²Œì´ì…˜ -->
    <div>
        {% if prev_photo %}
            <a href="{% url 'photo_gallery:photo_detail' prev_photo.pk %}">â† ì´ì „ ì‚¬ì§„</a>
        {% endif %}

        {% if next_photo %}
            <a href="{% url 'photo_gallery:photo_detail' next_photo.pk %}">ë‹¤ìŒ ì‚¬ì§„ â†’</a>
        {% endif %}
    </div>

    <!-- ì‚¬ì§„ -->
    <div>
        <img src="{{ photo.photo.url }}" alt="{{ photo.title }}">
    </div>

    <!-- ì‚¬ì§„ ì •ë³´ -->
    <div>
        <h1>{{ photo.title }}</h1>

        <p>ğŸ“· {{ photo.author.username }}</p>
        <p>ğŸ“… {{ photo.photo_date|date:"Yë…„ mì›” dì¼" }}</p>
        <p>ğŸ·ï¸ {{ photo.get_category_display }}</p>
        <p>{% if photo.is_public %}ğŸŒ ê³µê°œ{% else %}ğŸ”’ ë¹„ê³µê°œ{% endif %}</p>

        {% if photo.description %}
        <div>
            {{ photo.description|linebreaks }}
        </div>
        {% endif %}

        <!-- ì¢‹ì•„ìš” (í¼ ë°©ì‹) -->
        <!-- ì¢‹ì•„ìš” ì„¹ì…˜ -->
    <div id="likeSection">
        {% if user.is_authenticated %}
            <!-- ì¢‹ì•„ìš” ë²„íŠ¼ -->
            <button id="likeBtn"
                    data-photo-id="{{ photo.pk }}"
                    data-liked="{{ user_liked|lower }}">
                {% if user_liked %}
                    â¤ï¸ ì¢‹ì•„ìš” ì·¨ì†Œ
                {% else %}
                    ğŸ¤ ì¢‹ì•„ìš”
                {% endif %}
            </button>

            <!-- ì¢‹ì•„ìš” ìˆ˜ -->
            <span id="likeCount">{{ like_count }}</span>ëª…ì´ ì¢‹ì•„í•©ë‹ˆë‹¤

            <!-- ë©”ì‹œì§€ í‘œì‹œ ì˜ì—­ -->
            <div id="message"></div>
        {% else %}
            <p>ë¡œê·¸ì¸í•˜ë©´ ì¢‹ì•„ìš”ë¥¼ ëˆ„ë¥¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
        {% endif %}
    </div>

        <!-- ì‘ì„±ìë§Œ ìˆ˜ì •/ì‚­ì œ -->
        {% if user == photo.author %}
        <div>
            <a href="{% url 'photo_gallery:photo_update' photo.pk %}">ìˆ˜ì •</a>
            <a href="{% url 'photo_gallery:photo_delete' photo.pk %}">ì‚­ì œ</a>
        </div>

        
        {% endif %}
    </div>

    <!-- JavaScript (ë¡œê·¸ì¸í•œ ê²½ìš°ë§Œ) -->
    {% if user.is_authenticated %}
    <script>
        // 1. CSRF í† í° ê°€ì ¸ì˜¤ê¸° (Django ë³´ì•ˆ)
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // 2. Axios ê¸°ë³¸ ì„¤ì •
        axios.defaults.headers.common['X-CSRFToken'] = getCookie('csrftoken');

        // 3. HTML ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
        const likeBtn = document.getElementById('likeBtn');
        const likeCount = document.getElementById('likeCount');
        const messageDiv = document.getElementById('message');

        // 4. í˜„ì¬ ìƒíƒœ í™•ì¸
        let isLiked = likeBtn.dataset.liked === 'true';
        const photoId = likeBtn.dataset.photoId;

        // 5. ì¢‹ì•„ìš” ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        likeBtn.addEventListener('click', function() {
            // ì¤‘ë³µ í´ë¦­ ë°©ì§€
            likeBtn.disabled = true;
            likeBtn.textContent = 'ì²˜ë¦¬ì¤‘...';

            // Axiosë¡œ ì„œë²„ì— ìš”ì²­
            axios.post(`/photo/${photoId}/like_ajax/`)
                .then(response => {
                    // ì„±ê³µ! ì„œë²„ì—ì„œ ë°›ì€ ë°ì´í„°
                    const data = response.data;

                    // ìƒíƒœ ì—…ë°ì´íŠ¸
                    isLiked = data.liked;

                    // ë²„íŠ¼ í…ìŠ¤íŠ¸ ë³€ê²½
                    if (isLiked) {
                        likeBtn.textContent = 'â¤ï¸ ì¢‹ì•„ìš” ì·¨ì†Œ';
                    } else {
                        likeBtn.textContent = 'ğŸ¤ ì¢‹ì•„ìš”';
                    }

                    // ì¢‹ì•„ìš” ìˆ˜ ì—…ë°ì´íŠ¸
                    likeCount.textContent = data.like_count;

                    // ë©”ì‹œì§€ í‘œì‹œ (3ì´ˆ í›„ ì‚¬ë¼ì§)
                    messageDiv.textContent = data.message;
                    setTimeout(() => {
                        messageDiv.textContent = '';
                    }, 3000);
                })
                .catch(error => {
                    // ì—ëŸ¬ ì²˜ë¦¬
                    console.error('Error:', error);
                    messageDiv.textContent = 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';

                    // ë²„íŠ¼ ì›ìƒë³µêµ¬
                    if (isLiked) {
                        likeBtn.textContent = 'â¤ï¸ ì¢‹ì•„ìš” ì·¨ì†Œ';
                    } else {
                        likeBtn.textContent = 'ğŸ¤ ì¢‹ì•„ìš”';
                    }
                })
                .finally(() => {
                    // ì„±ê³µ/ì‹¤íŒ¨ ê´€ê³„ì—†ì´ ë²„íŠ¼ ë‹¤ì‹œ í™œì„±í™”
                    likeBtn.disabled = false;
                });
        });
    </script>
    {% endif %}
</body>
</html>
{% endblock %}